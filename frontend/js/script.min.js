let contract,signer,chartInstances={};async function loadContract(){try{console.log("ðŸ”„ Fetching Contract Address from Blockchain...");const e=await fetch("./abi/VotingSystem.json");if(!e.ok)throw new Error("âŒ Failed to fetch VotingSystem.json");const t=await e.json(),o=t.abi;if(console.log("contract abi is",o),void 0!==window.ethereum){console.log("ðŸ”„ Connecting to MetaMask..."),await window.ethereum.request({method:"eth_requestAccounts"});const e=new ethers.providers.Web3Provider(window.ethereum);signer=e.getSigner();const n=(await e.getNetwork()).chainId;if(console.log("ðŸ“Œ Network ID:",n),!t.networks[n])throw new Error(`âŒ Contract not deployed on network ${n}`);const a=t.networks[n].address;console.log("ðŸ“Œ Contract Address Found:",a),contract=new ethers.Contract(a,o,signer),console.log("âœ… Contract Loaded Successfully:",contract)}else console.error("âŒ MetaMask is required."),alert("âŒ MetaMask is not installed.")}catch(e){console.error("âŒ Error loading contract:",e),alert("âŒ Failed to load contract. Check console for errors.")}}const BASE_URL="http://192.168.0.170:5500";async function fetchCandidates(){try{const e=await fetch(`${BASE_URL}/candidates`),t=await e.json();if(t.success){console.log("the  data is ",t.candidates);const e=document.querySelector(".candidate-list");e.innerHTML="",t.candidates.forEach((t=>{const o=document.createElement("label");o.className="candidate-card",o.innerHTML=`\n                <input type="radio" name="candidate" value="${t.id}" required>\n                <span>${t.name||t.candidate}</span> \x3c!-- Fix Here --\x3e\n            `,e.appendChild(o)})),console.log("âœ… Candidates loaded successfully!")}else console.error("âŒ Failed to load candidates:",t.message)}catch(e){console.error("ðŸš¨ Error fetching candidates:",e)}}async function renderCollegeBlocOptions(){const e=localStorage.getItem("userCollege");console.log("the student's college",e);const t=document.querySelector(".college-bloc-list");if(e&&t){t.innerHTML="";try{const o=await fetch(`${BASE_URL}/college-blocs/${e}`),n=await o.json();if(console.log("the data is ",n),console.log(n.blocs),!n.success)return void console.error("âŒ Failed to fetch college blocs");n.blocs.forEach((e=>{const o=document.createElement("label");o.classList.add("candidate-card","university-card"),o.innerHTML=`\n      <input type="radio" name="collegeBloc" value="${e.name}" data-blocid="${e.id}" required>\n      <span>${e.name}</span>\n    `,t.appendChild(o)}))}catch(e){console.error("âŒ Error fetching college bloc options:",e)}}}async function checkIfAlreadyVoted(e=null){try{const t=e||await signer.getAddress(),o=await contract.voters(t),n=o[0],a=o[1];return n||a}catch(e){return console.error("âŒ Failed to check vote status from blockchain:",e),!1}}async function getUniversityBloccount(e){try{await new Promise((e=>setTimeout(e,2e3)));const t=await contract.getUniversityBloc(e);console.log(`ðŸ—³ Candidate ID: ${t[0].toString()}`),console.log(`ðŸ“Š Vote Count: ${t[1].toString()}`)}catch(e){console.error("âŒ Error fetching candidate:",e)}}async function getCollegeBloccount(e){try{await new Promise((e=>setTimeout(e,2e3)));const t=await contract.getCollegeBloc(e);console.log(`ðŸ—³ college ID: ${t[0].toString()}`),console.log(`ðŸ“Š Vote Count: ${t[1].toString()}`)}catch(e){console.error("âŒ Error fetching candidate:",e)}}let mychart,mychart1;async function fetchVotesAndDrawChart(e){try{const t=await fetch(`${BASE_URL}/results?college=${e}`),o=await t.json();if(!o.success)throw new Error("Failed to load results");const n={};o.university.forEach((e=>{n[e.name]=e.count}));const a={};o.college.forEach((e=>{a[e.name]=e.count})),drawChart("universityChart","University Bloc Results",n),drawChart("collegeChart",`College Bloc Results (${e})`,a)}catch(e){console.error("âŒ Error loading vote results:",e)}}function drawChart(e,t,o){const n=document.getElementById(e).getContext("2d");chartInstances[e]&&chartInstances[e].destroy();const a=Object.keys(o),l=Object.values(o);chartInstances[e]=new Chart(n,{type:"bar",data:{labels:a,datasets:[{label:t,data:l,backgroundColor:"rgba(75, 192, 192, 0.6)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,precision:0}},plugins:{title:{display:!0,text:t}}}})}async function fetchVotesAndDrawChart1(e=null){const t=e||localStorage.getItem("userCollege");try{const e=await fetch(`${BASE_URL}/results?college=${t}`),o=await e.json();if(console.log("ðŸ“¥ College Results Response:",o),!o.success||!Array.isArray(o.college))throw new Error("Backend did not return valid college data");const n={};o.college.forEach((e=>{n[e.name]=e.count})),drawChart("collegeChart",`College Bloc Results (${t})`,n)}catch(e){console.error("âŒ Error loading college vote results:",e)}}async function populateCollegeDropdown(){try{const e=await fetch(`${BASE_URL}/all-colleges`),t=await e.json(),o=document.getElementById("college-select");o.innerHTML="",t.colleges.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}));const n=localStorage.getItem("userCollege");o.value=n}catch(e){console.error("âŒ Failed to populate college list:",e)}}document.getElementById("theme-toggle").addEventListener("click",(()=>{const e=document.body;e.classList.contains("light")?(e.classList.remove("light"),e.classList.add("dark"),document.getElementById("theme-toggle").textContent="â˜€ï¸"):(e.classList.remove("dark"),e.classList.add("light"),document.getElementById("theme-toggle").textContent="ðŸŒ™")})),document.getElementById("toggle-password").addEventListener("click",(()=>{const e=document.getElementById("password"),t=document.getElementById("eye-icon");"password"===e.type?(e.type="text",t.innerHTML='\n      <path d="M17.94 17.94A10.29 10.29 0 0 1 12 20c-7 0-11-8-11-8a19.73 19.73 0 0 1 4.34-5.94" />\n      <line x1="1" y1="1" x2="23" y2="23" />\n    '):(e.type="password",t.innerHTML='\n      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n      <circle cx="12" cy="12" r="3"></circle>\n    '),e.focus()})),document.getElementById("login-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("email").value,o=document.getElementById("password").value;console.log("ðŸ“¤ Sending Login Request:",{email:t,password:o});try{const e=await fetch(`${BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:o})});let n;console.log("ðŸ“¥ Received Response:",e);try{n=await e.json()}catch(e){return console.error("âŒ Failed to parse JSON:",e),void alert("âš ï¸ Server returned invalid response. Please try again later.")}if(console.log("ðŸ“Š Parsed JSON Data:",n),n.success){console.log("âœ… Login successful!");const e=t,o=localStorage.getItem("loggedEmail");if(o&&o!==e&&(localStorage.removeItem(`votedUniversityName_${o}`),localStorage.removeItem(`votedCollegeName_${o}`),localStorage.removeItem(`wallet_${o}`)),localStorage.setItem("userCollege",n.college),localStorage.setItem("token",n.token),localStorage.setItem("role",n.role),localStorage.setItem("loggedEmail",e),"admin"===n.role)return console.log("ðŸ‘¨â€ðŸ’¼ Admin detected, redirecting to admin.html"),void(window.location.href="admin.html");document.getElementById("login-section").classList.add("hidden"),document.getElementById("voting-section").classList.remove("hidden"),document.getElementById("vote-results").classList.remove("hidden"),document.getElementById("sign-out").classList.remove("hidden"),document.getElementById("user-email").innerText=`Logged in as: ${e}`,await loadContract();const a=await signer.getAddress();localStorage.setItem(`wallet_${e}`,a),fetchCandidates(),renderCollegeBlocOptions();if(await checkIfAlreadyVoted(a)){const t=localStorage.getItem(`votedUniversityName_${e}`),o=localStorage.getItem(`votedCollegeName_${e}`);document.getElementById("voted-candidate").innerText=t&&o?`You voted for: University: ${t} | College: ${o}`:"You have already voted.",console.warn("âš ï¸ Blockchain confirms this user has already voted.")}else document.getElementById("voted-candidate").innerText="You have not voted yet.";populateCollegeDropdown()}else console.log("âŒ Login failed:",n.message),alert("âŒ Invalid credentials")}catch(e){console.error("ðŸš¨ Error logging in:",e),alert("âŒ Error logging in. Please try again later.")}})),document.getElementById("sign-out").addEventListener("click",(()=>{console.log("ðŸšª User signed out!");const e=localStorage.getItem("loggedEmail");e&&(localStorage.removeItem(`votedUniversityName_${e}`),localStorage.removeItem(`votedCollegeName_${e}`),localStorage.removeItem("loggedEmail")),localStorage.removeItem("userCollege"),localStorage.removeItem("token"),localStorage.removeItem("role"),document.getElementById("voting-section").classList.add("hidden"),document.getElementById("vote-results").classList.add("hidden"),document.getElementById("login-section").classList.remove("hidden"),document.getElementById("sign-out").classList.add("hidden"),document.getElementById("voted-candidate").innerText="You have not voted yet."})),document.getElementById("vote-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.querySelector('input[name="candidate"]:checked'),o=document.querySelector('input[name="collegeBloc"]:checked');if(!t||!o)return void alert("âš  Please select both a university bloc and a college bloc before submitting.");const n=ethers.utils.hexlify(ethers.utils.randomBytes(16)),a=t.value+n,l=o.value+n,c=ethers.utils.keccak256(ethers.utils.toUtf8Bytes(a)),s=ethers.utils.keccak256(ethers.utils.toUtf8Bytes(l));try{const e=await signer.getAddress(),n=await contract.voters(e),a=(n.hasVotedUniversity,n.hasVotedCollege,await contract.vote(c,parseInt(t.value),{from:e,gasLimit:5e5}));await a.wait();const l=await contract.voteCollegeBloc(s,parseInt(o.dataset.blocid),{from:e,gasLimit:5e5});await l.wait();const r=t.nextElementSibling.innerText,i=o.nextElementSibling.innerText;document.getElementById("voted-candidate").innerText=`You voted for: University: ${r} | College: ${i}`;const d=localStorage.getItem("loggedEmail");localStorage.setItem(`votedUniversityName_${d}`,r),localStorage.setItem(`votedCollegeName_${d}`,i),alert("âœ… Both votes cast successfully!"),document.getElementById("vote-results").classList.remove("hidden"),setTimeout((()=>{getUniversityBloccount(1),getUniversityBloccount(2),getUniversityBloccount(3),getCollegeBloccount(1),getCollegeBloccount(2),getCollegeBloccount(3),getCollegeBloccount(4),getCollegeBloccount(5),fetchVotesAndDrawChart()}),2e3),await fetchVotesAndDrawChart()}catch(e){console.error("âŒ Outer Error voting:",e);const t=e?.message||"";t.includes("Already voted")||t.includes("already voted")||t.includes("execution reverted")?(alert("âš ï¸ You have already voted. You can only vote once."),document.getElementById("voted-candidate").innerText="You have already voted."):alert("âŒ Error voting: "+t)}})),document.getElementById("refresh-results").addEventListener("click",(async()=>{const e=localStorage.getItem("userCollege");e?(console.log("ðŸ”„ Refreshing vote charts..."),await fetchVotesAndDrawChart(e),document.getElementById("vote-results").classList.remove("hidden")):alert("âš ï¸ Could not determine your college.")})),document.getElementById("college-select").addEventListener("change",(e=>{fetchVotesAndDrawChart1(e.target.value)}));